#!/usr/bin/env python3
"""
Auto-Passphrase SSH Authentication
Automatically injects passphrase into SSH without displaying on screen
"""

import subprocess
import tempfile
import os
import sys

def auto_ssh_with_passphrase(passphrase, ssh_command):
    """
    Execute SSH command with automatic passphrase injection
    Passphrase is never displayed on screen
    """
    
    print(f"ğŸ” AUTO-PASSPHRASE SSH AUTHENTICATION")
    print(f"ğŸš€ Command: {' '.join(ssh_command)}")
    print("ğŸ”’ Passphrase will be injected automatically (never displayed)")
    
    # Create temporary askpass script
    with tempfile.NamedTemporaryFile(mode='w', suffix='.sh', delete=False) as f:
        f.write(f'#!/bin/bash\necho "{passphrase}"\n')
        temp_askpass = f.name
    
    os.chmod(temp_askpass, 0o700)
    
    try:
        # Set environment for SSH_ASKPASS
        env = os.environ.copy()
        env['SSH_ASKPASS'] = temp_askpass
        env['DISPLAY'] = ':0'
        env['SSH_ASKPASS_REQUIRE'] = 'force'  # Force use of SSH_ASKPASS
        
        print("âœ… Temporary askpass script created")
        print("âœ… Environment variables set")
        print("ğŸ”‘ Executing SSH with automatic passphrase...")
        
        # Execute SSH command with automatic passphrase
        result = subprocess.run(
            ssh_command,
            env=env,
            capture_output=True,
            text=True,
            stdin=subprocess.DEVNULL  # Prevent interactive input
        )
        
        print(f"ğŸ“¤ SSH Exit Code: {result.returncode}")
        
        if result.stdout:
            print("ğŸ“‹ SSH Output:")
            print(result.stdout)
        
        if result.stderr:
            print("ğŸ“‹ SSH Messages:")
            print(result.stderr)
        
        # Clean up
        os.unlink(temp_askpass)
        
        return result.returncode == 0 or (result.returncode == 1 and "successfully authenticated" in result.stderr)
        
    except Exception as e:
        # Clean up temp file
        if os.path.exists(temp_askpass):
            os.unlink(temp_askpass)
        print(f"âŒ SSH error: {e}")
        return False

def test_fixed_passphrase():
    """Test with fixed passphrase value"""
    
    print("ğŸ§ª TESTING FIXED PASSPHRASE AUTO-INJECTION")
    print("=" * 50)
    
    # Fixed test passphrase
    test_passphrase = "1234"
    
    print(f"ğŸ”‘ Using fixed passphrase: {'*' * len(test_passphrase)} (never displayed)")
    print("ğŸ¯ Testing GitHub SSH authentication...")
    
    # Test SSH command
    ssh_cmd = ['ssh', '-o', 'StrictHostKeyChecking=no', '-T', 'github-zero-nfc-new']
    
    success = auto_ssh_with_passphrase(test_passphrase, ssh_cmd)
    
    if success:
        print("\nğŸ‰ AUTO-PASSPHRASE SSH SUCCESS")
        print("   âœ… Passphrase injected automatically")
        print("   âœ… No passphrase displayed on screen")
        print("   âœ… SSH authentication completed")
    else:
        print("\nâŒ AUTO-PASSPHRASE SSH FAILED")
        print("   Check SSH key and passphrase")
    
    return success

def test_nfc_generated_passphrase():
    """Test with NFC-generated passphrase from clipboard"""
    
    print("ğŸ§ª TESTING NFC-GENERATED PASSPHRASE AUTO-INJECTION")
    print("=" * 50)
    
    # Get passphrase from clipboard (previously generated by NFC system)
    try:
        result = subprocess.run(['pbpaste'], capture_output=True, text=True)
        clipboard_passphrase = result.stdout.strip()
        
        if not clipboard_passphrase:
            print("âŒ No passphrase found in clipboard")
            print("   Run invisible_passphrase_generator.py first")
            return False
        
        print(f"ğŸ”‘ Using NFC-generated passphrase from clipboard: {'*' * len(clipboard_passphrase)}")
        print("ğŸ¯ Testing GitHub SSH authentication...")
        
        # Test SSH command
        ssh_cmd = ['ssh', '-o', 'StrictHostKeyChecking=no', '-T', 'github-zero-nfc-new']
        
        success = auto_ssh_with_passphrase(clipboard_passphrase, ssh_cmd)
        
        if success:
            print("\nğŸ‰ NFC AUTO-PASSPHRASE SSH SUCCESS")
            print("   âœ… NFC-generated passphrase injected automatically")
            print("   âœ… No passphrase displayed on screen")
            print("   âœ… Zero-knowledge authentication completed")
        else:
            print("\nâŒ NFC AUTO-PASSPHRASE SSH FAILED")
            print("   Check NFC passphrase generation and SSH key")
        
        return success
        
    except Exception as e:
        print(f"âŒ Failed to get passphrase from clipboard: {e}")
        return False

def main():
    """Main auto-passphrase SSH test"""
    
    print("ğŸ” Auto-Passphrase SSH Authentication System")
    print("ğŸš€ Automatically injects passphrases into SSH without screen display")
    print()
    
    print("ğŸ“‹ AVAILABLE TESTS:")
    print("1. Fixed passphrase test (1234)")
    print("2. NFC-generated passphrase test (from clipboard)")
    print()
    
    choice = input("Select test (1 or 2): ").strip()
    
    if choice == "1":
        test_fixed_passphrase()
    elif choice == "2":
        test_nfc_generated_passphrase()
    else:
        print("âŒ Invalid choice")

if __name__ == "__main__":
    main()
